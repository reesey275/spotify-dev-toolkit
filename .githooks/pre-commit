#!/usr/bin/env bash
# Simple pre-commit hook to detect common secret patterns in staged files.
# This is intentionally lightweight and repository-local; for stronger checks
# integrate with `pre-commit` or `detect-secrets` in CI.

set -euo pipefail

echo "Running lightweight secret scan on staged files..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | sed '/^$/d')
if [ -z "$STAGED_FILES" ]; then
  echo "No staged files to check."
  exit 0
fi

FAIL=0

for file in $STAGED_FILES; do
  # Only scan text files
  if file --brief --mime "$file" 2>/dev/null | grep -q text; then
    # Look for common AWS key pattern
    if git show :"$file" | grep -E --quiet 'AKIA[0-9A-Z]{16}'; then
      echo "[secret-scan] Potential AWS access key in $file"
      FAIL=1
    fi

    # Look for private key beginnings
    if git show :"$file" | grep -E --quiet '-----BEGIN (RSA |OPENSSH |PRIVATE )?PRIVATE KEY-----'; then
      echo "[secret-scan] Private key detected in $file"
      FAIL=1
    fi

    # Look for obvious Spotify client secret env var copies
    if git show :"$file" | grep -E --quiet 'SPOTIFY_CLIENT_SECRET\s*=|SPOTIFY_CLIENT_ID\s*='; then
      echo "[secret-scan] Spotify credential pattern found in $file"
      FAIL=1
    fi

    # Generic token patterns
    if git show :"$file" | grep -E --quiet '(?:api_key|apiKey|token|secret)\s*[:=]\s*["'"']?[A-Za-z0-9\-_=]{20,}'; then
      echo "[secret-scan] Generic token-like pattern in $file"
      FAIL=1
    fi
  fi
done

if [ "$FAIL" -eq 1 ]; then
  echo "\nSecret scan failed. Remove secrets from staged files or move them to environment variables/vault." >&2
  echo "To enable local hooks run: git config core.hooksPath .githooks" >&2
  exit 1
fi

echo "Secret scan passed."
exit 0
